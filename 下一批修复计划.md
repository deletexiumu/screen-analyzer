# 下一批修复计划

**生成日期**: 2025-10-01

## 当前修复进度

- ✅ **已完成**: 17/29 问题
- ⏸️ **已跳过**: 1/29 问题（#4 API Key 安全性）
- 🔜 **待修复**: 11/29 问题

---

## 下一批建议修复（按优先级排序）

### 🔥 高优先级（建议本周修复）

#### 1. 问题 #25: 路径遍历风险 ⚠️ 安全
**文件**: `src-tauri/src/lib.rs:1209`
**严重程度**: 🟢 轻微（但涉及安全）
**修复难度**: ⭐ 简单
**预计时间**: 15分钟

**问题描述**: `open_storage_folder` 接受字符串参数 `folder_type`，虽然有白名单检查，但建议使用枚举类型加强类型安全。

**修复方案**:
```rust
// 1. 定义枚举类型
#[derive(Debug, serde::Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum FolderType {
    Frames,
    Videos,
}

// 2. 修改函数签名
#[tauri::command]
async fn open_storage_folder(
    folder_type: FolderType,
    state: tauri::State<'_, AppState>
) -> Result<(), String>
```

---

#### 2. 问题 #28: HTTP 客户端未复用 ⚡ 性能
**文件**: `src-tauri/src/llm/qwen.rs:23`
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**预计时间**: 30分钟

**问题描述**: 每个 LLM provider 创建新的 `reqwest::Client`，未共享连接池，影响性能。

**修复方案**:
```rust
// 1. 在 AppState 中添加全局 HTTP 客户端
pub struct AppState {
    pub http_client: Arc<reqwest::Client>,
    // ... 其他字段
}

// 2. 初始化时创建共享客户端
let http_client = reqwest::Client::builder()
    .timeout(Duration::from_secs(300))
    .pool_max_idle_per_host(10)
    .build()?;

// 3. 修改 LLM provider 构造函数接受 Arc<Client>
```

---

### ⚡ 中优先级（建议本月修复）

#### 3. 问题 #26: 文件权限问题 ⚠️ 安全
**文件**: `src-tauri/src/video/ffmpeg_helper.rs:76-87`
**严重程度**: 🟢 轻微
**修复难度**: ⭐ 简单
**预计时间**: 10分钟

**问题描述**: Unix 系统上 FFmpeg 文件权限为 0o755 过于宽松。

**修复方案**:
```rust
#[cfg(unix)]
{
    use std::os::unix::fs::PermissionsExt;
    let mut perms = fs::metadata(&ffmpeg_path)?.permissions();
    perms.set_mode(0o750); // 限制为所有者和组
    fs::set_permissions(&ffmpeg_path, perms)?;
}
```

---

#### 4. 问题 #24: SQL 注入风险（轻微）⚠️ 安全
**文件**: `src-tauri/src/storage/database.rs`
**严重程度**: 🟢 轻微
**修复难度**: ⭐ 简单
**预计时间**: 15分钟

**问题描述**: 虽然使用了参数化查询，但建议添加输入验证增强防御。

**修复方案**:
```rust
// 添加输入验证函数
fn validate_session_id(id: i64) -> Result<(), String> {
    if id < 0 {
        return Err("无效的会话 ID".to_string());
    }
    Ok(())
}

// 在 Tauri 命令中使用
#[tauri::command]
async fn get_session(session_id: i64, state: State<'_, AppState>) -> Result<Session, String> {
    validate_session_id(session_id)?;
    // ... 继续处理
}
```

---

#### 5. 问题 #29: 大量字符串分配 ⚡ 性能
**文件**: `src-tauri/src/lib.rs:500-512`
**严重程度**: 🟢 轻微
**修复难度**: ⭐ 简单
**预计时间**: 15分钟

**问题描述**: 视频帧去重时创建大量临时字符串。

**修复方案**: （实际上当前代码可能已经优化，需要检查是否仍存在此问题）

---

### 📋 低优先级（下个迭代）

#### 6. 问题 #18: 文档注释缺失 📝 文档
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**预计时间**: 1-2小时

为主要的 Tauri 命令添加文档注释。

---

#### 7. 问题 #19: 时区处理不一致 🕐 数据
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**预计时间**: 30分钟

统一使用 UTC 存储，只在显示时转换本地时间。

---

#### 8. 问题 #20: 前端错误处理不完善 🎨 前端
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**预计时间**: 1小时

为所有 Tauri invoke 调用添加错误处理。

---

#### 9-11. 问题 #21-23: 架构优化 🏗️ 架构
**严重程度**: 🟡 中等
**修复难度**: ⭐⭐⭐⭐ 复杂
**预计时间**: 4-8小时

这些是大规模重构，建议在新版本中统一处理：
- #21: 全局状态管理混乱
- #22: 循环依赖
- #23: 过度使用 Arc<Mutex<T>>

---

## 修复建议

### 本周目标（预计 1.5 小时）
修复 #25, #28 两个问题，提升安全性和性能。

### 本月目标（预计 2.5 小时）
完成 #24, #26, #29 的修复，完善安全防护和性能优化。

### 下个版本目标
- 完成轻微问题 #18-20 的修复
- 规划架构重构 #21-23

---

## 修复优先级说明

**优先级判断标准**:
1. **安全性问题** > 性能问题 > 代码质量问题
2. **修复成本低** 且 **收益高** 的问题优先
3. **用户可感知** 的问题优先于内部代码质量问题

**当前批次选择理由**:
- #25, #24, #26: 安全相关，虽然风险较低但应该修复
- #28: 性能问题，修复简单且效果明显
- #29: 性能问题，修复简单

**暂缓修复的理由**:
- #18-20: 影响较小，可以延后
- #21-23: 架构级重构，需要更多时间规划和测试
