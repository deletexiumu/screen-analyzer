# 下一批修复计划

**生成日期**: 2025-10-01

## 当前修复进度

- ✅ **已完成**: 25/29 问题
- ⏸️ **已跳过**: 1/29 问题（#4 API Key 安全性）
- 🔜 **待修复**: 3/29 问题

---

## 下一批建议修复（按优先级排序）

### 🔥 高优先级 ✅ 已完成

#### 1. 问题 #25: 路径遍历风险 ✅ 已修复
**文件**: `src-tauri/src/lib.rs:1209`
**严重程度**: 🟢 轻微（但涉及安全）
**修复难度**: ⭐ 简单
**完成时间**: 2025-10-01

**修复内容**:
- 添加 `FolderType` 枚举类型（Frames、Videos）
- 修改 `open_storage_folder` 函数使用枚举参数替代字符串

---

#### 2. 问题 #28: HTTP 客户端未复用 ✅ 已修复
**文件**: `src-tauri/src/llm/qwen.rs:23`
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**完成时间**: 2025-10-01

**修复内容**:
- 在 `AppState` 添加 `http_client: Arc<reqwest::Client>` 字段
- 创建共享 HTTP 客户端（超时300秒，连接池10个）
- 修改 `LLMManager` 和 `QwenProvider` 接受共享客户端参数

---

### ⚡ 中优先级 ✅ 已完成

#### 3. 问题 #26: 文件权限问题 ✅ 已修复
**文件**: `src-tauri/src/video/ffmpeg_helper.rs:76-87`
**严重程度**: 🟢 轻微
**修复难度**: ⭐ 简单
**完成时间**: 2025-10-01

**修复内容**:
- 将 FFmpeg 文件权限从 `0o755` 改为 `0o750`

---

#### 4. 问题 #24: SQL 注入风险 ✅ 已修复
**文件**: `src-tauri/src/storage/database.rs`
**严重程度**: 🟢 轻微
**修复难度**: ⭐ 简单
**完成时间**: 2025-10-01

**修复内容**:
- 添加 `validate_session_id()` 输入验证函数
- 在所有使用 `session_id` 的 Tauri 命令中添加验证调用

---

#### 5. 问题 #29: 大量字符串分配 ✅ 已修复
**文件**: `src-tauri/src/lib.rs:500-512`
**严重程度**: 🟢 轻微
**修复难度**: ⭐ 简单
**完成时间**: 2025-10-01

**修复内容**:
- 优化视频帧过滤逻辑，先过滤再克隆，避免克隆所有帧路径

---

### 📋 低优先级 ✅ 已完成

#### 6. 问题 #18: 文档注释缺失 ✅ 已修复
**文件**: `src-tauri/src/lib.rs:79-89`
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**完成时间**: 2025-10-01

**修复内容**:
- 为主要的 Tauri 命令添加了完整的文档注释
- 包括参数说明和返回值描述

---

#### 7. 问题 #19: 时区处理不一致 ✅ 已修复
**文件**: `src-tauri/src/storage/database.rs:246-311`
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**完成时间**: 2025-10-01

**修复内容**:
- 移除 `localtime` 时区转换，统一使用 UTC 时间查询
- 简化 `get_sessions_by_date` 查询逻辑
- 添加文档注释说明时区处理策略

---

#### 8. 问题 #20: 前端错误处理不完善 ✅ 已修复
**文件**: `src/stores/activity.js:145,176,347`
**严重程度**: 🟢 轻微
**修复难度**: ⭐⭐ 中等
**完成时间**: 2025-10-01

**修复内容**:
- 为 `fetchSystemStatus`、`fetchAppConfig`、`fetchStorageStats` 添加错误提示
- 所有错误处理使用 `ElMessage.error` 向用户显示友好的错误信息

---

### 🏗️ 架构优化（未来版本）

#### 9-11. 问题 #21-23: 架构优化 🏗️ 架构
**严重程度**: 🟡 中等
**修复难度**: ⭐⭐⭐⭐ 复杂
**预计时间**: 4-8小时

这些是大规模重构，建议在新版本中统一处理：
- #21: 全局状态管理混乱
- #22: 循环依赖
- #23: 过度使用 Arc<Mutex<T>>

---

## 修复建议

### ✅ 已完成目标（共计约 3 小时）
- ✅ 修复 #25, #28 两个问题，提升安全性和性能
- ✅ 完成 #24, #26, #29 的修复，完善安全防护和性能优化
- ✅ 完成 #18-20 的修复，完善文档注释、时区处理和前端错误处理

### 下个版本目标
- 规划架构重构 #21-23（全局状态管理、循环依赖、过度使用 Arc<Mutex<T>>）

---

## 修复优先级说明

**优先级判断标准**:
1. **安全性问题** > 性能问题 > 代码质量问题
2. **修复成本低** 且 **收益高** 的问题优先
3. **用户可感知** 的问题优先于内部代码质量问题

**已完成批次总结**:
- ✅ #25, #24, #26: 安全相关问题已全部修复
- ✅ #28, #29: 性能问题已优化完成
- ✅ #18-20: 轻微问题已全部修复（文档注释、时区处理、前端错误处理）
- 共计修复 8 个问题，用时约 3 小时

**下一批次建议**:
- #21-23: 架构级重构（需要更多时间规划和测试，建议在新版本中统一处理）
